<!DOCTYPE html>
<html lang="es">
<head>
	<script src="js/supabase-config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de POS - Comercio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .pos-container {
            max-width: 600px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .card-input {
            font-family: 'Courier New', monospace;
            font-size: 1.2em;
            text-align: center;
            letter-spacing: 2px;
        }
        .bank-info {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .bank-venezuela { background-color: #e3f2fd; border-left: 4px solid #1976d2; }
        .bank-banco-uno { background-color: #fff3e0; border-left: 4px solid #f57c00; }
        .bank-banco-cinco { background-color: #f3e5f5; border-left: 4px solid #7b1fa2; }
        .bank-unknown { background-color: #ffebee; border-left: 4px solid #d32f2f; }
        
        .processing {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .receipt {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="pos-container">
            <div class="text-center mb-4">
                <h2>üè™ Terminal POS</h2>
                <p class="text-muted">Simulador de Punto de Venta</p>
                <p><strong>Comercio:</strong> Supermercado Central</p>
            </div>

            <form id="posForm">
                <div class="mb-4">
                    <label for="cardNumber" class="form-label">üí≥ N√∫mero de Tarjeta</label>
                    <input type="text" class="form-control card-input" id="cardNumber" 
                           placeholder="0000-0000-0000-0000" maxlength="19"
                           onkeyup="formatCardNumber(this); detectBank(this.value)">
                    <small class="form-text text-muted">
                        Pruebe: 4532 (Meridian Banco), 5555 (Banco Uno), 4444 (Banco Cinco)
                    </small>
                </div>

                <div id="bankInfo" class="bank-info" style="display: none;">
                    <strong>üè¶ Banco detectado:</strong> <span id="bankName"></span>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <label for="amount" class="form-label">üí∞ Monto</label>
                        <input type="text" class="form-control" id="amount" 
                               placeholder="1.000,00" 
                               oninput="formatAmountInput(this)"
                               onfocus="clearAmountPlaceholder(this)"
                               onblur="validateAmountInput(this)">
                        <small class="form-text text-muted">Formato: 1.234,56</small>
                    </div>
                    <div class="col-md-6">
                        <label for="cvv" class="form-label">üîê CVV</label>
                        <input type="text" class="form-control" id="cvv" 
                               placeholder="CVV" maxlength="3" 
                               oninput="this.value = this.value.replace(/\D/g, '').substring(0,3)">
                        <small class="form-text text-muted">3 d√≠gitos de seguridad</small>
                    </div>
                </div>

                <div class="mb-3 mt-3">
                    <label for="description" class="form-label">üìù Descripci√≥n</label>
                    <input type="text" class="form-control" id="description" 
                           value="Compra en Supermercado Central">
                </div>

                <button type="button" class="btn btn-primary btn-lg w-100" onclick="processPayment()">
                    üí≥ Procesar Pago
                </button>
            </form>

            <div id="processing" class="processing">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3">Procesando transacci√≥n...</p>
                <small class="text-muted">Conectando con el banco emisor...</small>
            </div>

            <div id="receipt" class="receipt"></div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script>
        // ============================================
        // FORMATEO DE MONTO EN FORMATO VENEZOLANO
        // ============================================
        
        // Formatear monto mientras el usuario escribe
        function formatAmountInput(input) {
            let value = input.value;
            
            // Remover todo excepto n√∫meros
            let cleanValue = value.replace(/[^0-9]/g, '');
            
            // Si est√° vac√≠o, no hacer nada
            if (cleanValue === '') {
                input.value = '';
                return;
            }
            
            // Convertir a n√∫mero y dividir por 100 para obtener formato decimal
            let numericValue = parseInt(cleanValue);
            
            // Formatear como moneda venezolana
            let formattedValue = formatAsVenezuelanCurrency(numericValue / 100);
            
            input.value = formattedValue;
        }
        
        // Formatear n√∫mero como moneda venezolana (1234.56 -> 1.234,56)
        function formatAsVenezuelanCurrency(amount) {
            // Convertir a string con 2 decimales fijos
            let fixedAmount = amount.toFixed(2);
            
            // Separar parte entera y decimal
            let [integerPart, decimalPart] = fixedAmount.split('.');
            
            // Agregar separadores de miles (puntos) a la parte entera
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            // Combinar con coma como separador decimal
            return integerPart + ',' + decimalPart;
        }
        
        // Limpiar placeholder cuando recibe foco
        function clearAmountPlaceholder(input) {
            if (input.value === '' || input.value === '1.000,00') {
                input.value = '';
            }
        }
        
        // Validar monto al perder foco
        function validateAmountInput(input) {
            if (input.value === '' || input.value === '0,00') {
                input.placeholder = '1.000,00';
                input.value = '';
            }
        }
        
        // Convertir formato venezolano a n√∫mero para c√°lculos
        function parseVenezuelanAmount(formattedAmount) {
            if (!formattedAmount || formattedAmount === '') return 0;
            
            // Remover separadores de miles (puntos) y reemplazar coma decimal por punto
            return parseFloat(formattedAmount.replace(/\./g, '').replace(',', '.')) || 0;
        }
        
        // ============================================
        // FUNCIONES EXISTENTES
        // ============================================
        
        // Formatear n√∫mero de tarjeta
        function formatCardNumber(input) {
            let value = input.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = '';
            
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) {
                    formattedValue += '-';
                }
                formattedValue += value[i];
            }
            
            input.value = formattedValue;
        }

        // Detectar banco por prefijo
        function detectBank(cardNumber) {
            const cleanNumber = cardNumber.replace(/[\s-]/g, '');
            const bankInfo = document.getElementById('bankInfo');
            const bankName = document.getElementById('bankName');
            
            if (cleanNumber.length < 4) {
                bankInfo.style.display = 'none';
                return;
            }
            
            // Detectar banco usando la funci√≥n del sistema
            const detectedBank = detectBankByCardNumber(cleanNumber);
            
            if (detectedBank) {
                bankName.textContent = detectedBank.name;
                bankInfo.className = `bank-info bank-${detectedBank.bankKey.toLowerCase().replace('_', '-')}`;
                bankInfo.style.display = 'block';
            } else {
                bankName.textContent = 'Banco no reconocido';
                bankInfo.className = 'bank-info bank-unknown';
                bankInfo.style.display = 'block';
            }
        }

        // Validar CVV contra tarjeta
        function validateCVV(cardNumber, cvv) {
            // Remover guiones de la tarjeta
            const cleanCardNumber = cardNumber.replace(/[\s-]/g, '');
            
            // Base de datos de tarjetas conocidas (simulaci√≥n del sistema bancario)
            const knownCards = {
                '4532123456789012': '123', // Juan Carlos P√©rez
                '4532234567890123': '456', // Mar√≠a Elena Rodr√≠guez
                // Se pueden agregar m√°s tarjetas aqu√≠
            };
            
            // Si es una tarjeta conocida, validar el CVV
            if (knownCards[cleanCardNumber]) {
                return knownCards[cleanCardNumber] === cvv;
            }
            
            // Para tarjetas no conocidas (de otros bancos), generar CVV simulado
            // Esto simula la consulta al banco emisor
            if (cleanCardNumber.length === 16) {
                // Generar CVV basado en los √∫ltimos d√≠gitos (simulaci√≥n)
                const lastDigits = cleanCardNumber.slice(-4);
                const simulatedCVV = ((parseInt(lastDigits) % 900) + 100).toString();
                return simulatedCVV === cvv;
            }
            
            return false; // Tarjeta inv√°lida
        }

        // Procesar pago
        async function processPayment() {
            const cardNumber = document.getElementById('cardNumber').value.replace(/[\s-]/g, '');
            const amount = parseVenezuelanAmount(document.getElementById('amount').value);
            const cvv = document.getElementById('cvv').value;
            const description = document.getElementById('description').value;

            // Validaciones b√°sicas
            if (!cardNumber || cardNumber.length < 16) {
                alert('Por favor ingrese un n√∫mero de tarjeta v√°lido');
                return;
            }

            if (!amount || amount <= 0) {
                alert('Por favor ingrese un monto v√°lido mayor a 0,00');
                return;
            }

            if (!cvv || cvv.length !== 3) {
                alert('Por favor ingrese un CVV v√°lido de 3 d√≠gitos');
                return;
            }

            // Validaci√≥n espec√≠fica de CVV vs tarjeta
            if (!validateCVV(cardNumber, cvv)) {
                alert('‚ùå CVV INV√ÅLIDO\n\nEl CVV ingresado no corresponde a esta tarjeta.\nVerifique los datos e intente nuevamente.');
                return;
            }

            // Mostrar procesando
            document.getElementById('posForm').style.display = 'none';
            document.getElementById('processing').style.display = 'block';

            try {
                // Procesar pago usando el sistema interbancario
                const result = await useCreditCard(amount, description, cardNumber);
                
                // Si la transacci√≥n fue exitosa, guardarla en el sistema de liquidaci√≥n
                if (result.success) {
                    await savePendingSettlement(cardNumber, amount, description, result);
                }
                
                // Ocultar procesando
                document.getElementById('processing').style.display = 'none';
                
                // Mostrar resultado
                showReceipt(result, cardNumber, amount, description);
                
            } catch (error) {
                document.getElementById('processing').style.display = 'none';
                document.getElementById('posForm').style.display = 'block';
                alert('Error procesando el pago: ' + error.message);
            }
        }

        // Mostrar recibo
        function showReceipt(result, cardNumber, amount, description) {
            const receipt = document.getElementById('receipt');
            const maskedCard = cardNumber.replace(/\d(?=\d{4})/g, '*');
            const timestamp = new Date().toLocaleString('es-VE');
            
            let receiptHTML = `
                <div class="text-center mb-3">
                    <h5>üßæ RECIBO DE TRANSACCI√ìN</h5>
                    <small>Supermercado Central</small>
                </div>
                <hr>
                <div>
                    <strong>Fecha:</strong> ${timestamp}<br>
                    <strong>Tarjeta:</strong> ${maskedCard}<br>
                    <strong>Monto:</strong> ${formatCurrency(amount)}<br>
                    <strong>Descripci√≥n:</strong> ${description}<br>
                </div>
                <hr>
            `;

            if (result.success) {
                receiptHTML += `
                    <div class="text-success text-center">
                        <h4>‚úÖ TRANSACCI√ìN APROBADA</h4>
                        <p>${result.message}</p>
                        ${result.authCode ? `<small>C√≥digo de autorizaci√≥n: ${result.authCode}</small>` : ''}
                        ${result.bankName ? `<br><small>Procesado por: ${result.bankName}</small>` : ''}
                    </div>
                `;
            } else {
                receiptHTML += `
                    <div class="text-danger text-center">
                        <h4>‚ùå TRANSACCI√ìN RECHAZADA</h4>
                        <p>${result.message}</p>
                    </div>
                `;
            }

            receiptHTML += `
                <hr>
                <div class="text-center mt-3">
                    <button class="btn btn-secondary" onclick="newTransaction()">Nueva Transacci√≥n</button>
                </div>
            `;

            receipt.innerHTML = receiptHTML;
            receipt.style.display = 'block';
        }

        // Guardar transacci√≥n pendiente de liquidaci√≥n
        async function savePendingSettlement(cardNumber, amount, description, result) {
            // Obtener transacciones pendientes existentes
            let pendingSettlements = JSON.parse(localStorage.getItem('pendingSettlements')) || [];
            
            // Normalizar formato de tarjeta (asegurar formato con guiones)
            const formattedCardNumber = cardNumber.replace(/[\s-]/g, '').replace(/(.{4})/g, '$1-').slice(0, -1);
            
            // Crear nueva transacci√≥n pendiente
            const transaction = {
                id: 'POS' + Date.now() + Math.random().toString(36).substr(2, 5),
                cardNumber: formattedCardNumber, // Usar formato normalizado
                maskedCard: formattedCardNumber.replace(/\d(?=\d{4})/g, '*'),
                amount: amount,
                description: description,
                authCode: result.authCode,
                bankName: result.bankName,
                commerceName: 'Supermercado Central',
                timestamp: new Date().toISOString(),
                displayTime: new Date().toLocaleString('es-VE'),
                status: 'PENDIENTE_LIQUIDACION',
                type: 'COMPRA_POS'
            };
            
            // Agregar a la lista
            pendingSettlements.push(transaction);
            
            // Guardar en localStorage
            localStorage.setItem('pendingSettlements', JSON.stringify(pendingSettlements));
            
            console.log('Transacci√≥n guardada para liquidaci√≥n:', transaction);
            
            // üîÑ NUEVA FUNCIONALIDAD: Guardar tambi√©n en tabla transactions de Supabase
            await saveTransactionToSupabaseFromPOS(transaction, result);
        }
        
        // Funci√≥n para guardar transacciones de POS en Supabase
        async function saveTransactionToSupabaseFromPOS(transaction, authResult) {
            try {
                // Si es una transacci√≥n de nuestro banco, procesar completa
                if (authResult.bankName === 'Meridian Banco') {
                    // Buscar el cliente propietario de la tarjeta
                    const clientsDatabase = JSON.parse(localStorage.getItem('clientsDatabase') || '{}');
                    
                    for (const [username, clientInfo] of Object.entries(clientsDatabase)) {
                        let clientData = clientInfo.clientData || clientInfo;
                        
                        // Verificar si esta tarjeta pertenece a este cliente
                        if (clientData && clientData.creditCard && 
                            clientData.creditCard.cardNumber === transaction.cardNumber) {
                            
                            // Crear transacci√≥n en formato est√°ndar
                            const standardTransaction = {
                                id: transaction.id,
                                date: new Date().toISOString().split('T')[0],
                                description: `${transaction.description} (POS: ${transaction.commerceName})`,
                                amount: -transaction.amount, // Negativo porque es un gasto
                                type: 'Tarjeta de Cr√©dito',
                                reference: `POS-${transaction.authCode}`,
                                accountId: clientData.account ? clientData.account.accountId : `ACC_${username}_001`,
                                authCode: transaction.authCode,
                                source: 'POS_MERIDIAN'
                            };
                            
                            // Actualizar saldo de tarjeta de cr√©dito
                            const amountInCents = Math.round(transaction.amount * 100);
                            const currentBalanceInCents = Math.round(clientData.creditCard.currentBalance * 100);
                            const availableCreditInCents = Math.round(clientData.creditCard.availableCredit * 100);
                            
                            clientData.creditCard.currentBalance = (currentBalanceInCents + amountInCents) / 100;
                            clientData.creditCard.availableCredit = (availableCreditInCents - amountInCents) / 100;
                            
                            // Agregar transacci√≥n al historial del cliente
                            if (!clientData.transactions) clientData.transactions = [];
                            clientData.transactions.unshift(standardTransaction);
                            
                            // Guardar en sistema h√≠brido (Supabase primero, localStorage fallback)
                            if (typeof saveCreditCardHybrid !== 'undefined') {
                                await saveCreditCardHybrid(username, clientData);
                            }
                            
                            // Guardar transacci√≥n individual en Supabase
                            if (typeof saveTransactionToSupabase !== 'undefined') {
                                await saveTransactionToSupabase(username, standardTransaction);
                            }
                            
                            // Actualizar localStorage de clientes
                            if (clientInfo.clientData) {
                                clientInfo.clientData = clientData;
                            } else {
                                Object.assign(clientInfo, clientData);
                            }
                            clientsDatabase[username] = clientInfo;
                            localStorage.setItem('clientsDatabase', JSON.stringify(clientsDatabase));
                            
                            console.log(`‚úÖ Transacci√≥n POS guardada en Supabase para ${username}:`, standardTransaction);
                            break;
                        }
                    }
                } else {
                    // Transacci√≥n de banco externo - solo registrar como movimiento interbancario
                    const interbankTransaction = {
                        id: transaction.id,
                        date: new Date().toISOString().split('T')[0],
                        description: `Compra interbancaria: ${transaction.description} (${transaction.bankName})`,
                        amount: transaction.amount,
                        type: 'Transacci√≥n Interbancaria',
                        reference: `INTER-${transaction.authCode}`,
                        authCode: transaction.authCode,
                        source: 'POS_EXTERNAL',
                        external_bank: transaction.bankName,
                        commerce_name: transaction.commerceName
                    };
                    
                    console.log(`üìù Transacci√≥n interbancaria registrada:`, interbankTransaction);
                    // Aqu√≠ podr√≠as enviar a un sistema de registro de transacciones interbancarias
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error guardando transacci√≥n POS en Supabase:', error);
            }
        }

        // Nueva transacci√≥n
        function newTransaction() {
            document.getElementById('posForm').reset();
            document.getElementById('posForm').style.display = 'block';
            document.getElementById('receipt').style.display = 'none';
            document.getElementById('bankInfo').style.display = 'none';
        }

        // Formatear moneda
        function formatCurrency(amount) {
            return new Intl.NumberFormat('es-VE', {
                style: 'currency',
                currency: 'VES'
            }).format(amount);
        }
    </script>
</body>
</html>